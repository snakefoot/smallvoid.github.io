---
title: 'Graweg NetApi32.dll Exploit'
date: '2006-10-10T18:34:03+02:00'
status: publish
permalink: /article/winnt-graweg-netapi32-exploit.html
author: Snakefoot
excerpt: 'Description of the Graweg worm and how to protect against its SMB attacks.'
type: post
id: 594
category:
    - Troubleshoot
    - Troubleshoot
    - Troubleshoot
tag:
    - exploit
    - graweg
    - virus
    - worms
post_format: []
tags:
    - 'graweg,worms,exploit,virus'
---
##### Exploit details:

 There is a buffer overrun vulnerability in the [Server service](/article/winnt-services-lanmanserver.html). By default the Server service listens on port 139 and port 445 and by sending a special crafted message to this port, then it is possible to execute malicious commands within the context of the Server service.  
  
 The following operating systems have this security hole:
- Windows 2000 SP1, SP2, SP3, SP4
- Windows XP SP1, SP2
- Windows 2003 SP1
 
 This means that after having made a clean install of Windows 2000/XP/2003, and one connects to the Internet without a firewall activated, then one is vulnerable to attacks. The [Graweg worm](http://onecare.live.com/standard/en-us/virusenc/VirusEncInfo.htm?VirusID=3661) is the most common attacker.
 
##### Exploit side effects:

 The [Server service](/article/winnt-services-lanmanserver.html) is not vital for the operation of Windows, but it resides in the [netsvcs](/article/winnt-services-wrapper.html) service wrapper along with other vital services like [COM+ Event System](/article/winnt-services-eventsystem.html) and [Network Service](/article/winnt-services-netman.html). When vulnerable to attacks then the service wrapper might crash, and cause COM+ applications to fail and block the network/internet access. One of the following messages are usually shown when it crashes:
> *Generic Host Process for Win32 Services has encountered a problem and needs to close. We are sorry for the inconvenience.  
>   
>  Faulting application svchost.exe, version 5.1.2600.2180, faulting module netapi32.dll, version 5.1.2600.2180, fault address 0x0000a3c0.  
>   
>  Faulting application svchost.exe, version 5.2.3790.1830, faulting module netapi32.dll, version 5.2.3790.1830, fault address 0x0000a2be.*

 The result of the attacks is usually that the system becomes infected with a virus, which take control of the CPU and the Internet bandwidth, and it is then used for attacking other machines on the Internet.
 
##### Solution to prevent exploit:

1. Consider enabling a firewall to prevent future attacks (Like [Windows XP Firewall](/article/winxp-firewall.html))
2. Download and install the Microsoft patch [MS06-040 Vulnerability in Server Service Could Allow Remote Code Execution (921883)](http://www.microsoft.com/technet/security/bulletin/ms06-040.mspx). 
  - If unable to install the patch in normal mode, then [boot in safemode](http://support.microsoft.com/kb/315222 "A description of the Safe Mode Boot options in Windows XP [Q315222]") and install it.
  - If installing the patch in safemode, then remember to reinstall the patch afterwards in normal mode. More Info [MS KB818460](http://support.microsoft.com/kb/818460 "How to Install Service Packs and Hotfixes When Windows Is Running in Safe Mode [Q818460]")
3. Download the newest virus database for your existing AntiVira Scanner and scan or use [housecall.antivirus.com](http://housecall.antivirus.com/). (If using WinXP remember to [turn off System Restore](http://support.microsoft.com/kb/310405 "How to turn off and turn on System Restore in Windows XP [Q310405]") temporarily) 
  - Sophos have created a dedicated removal tool [CUEBTGUI](http://www.sophos.com/support/disinfection/cuebot.html)
4. Check [Windows Update](http://v4.windowsupdate.microsoft.com/) to see if there are other critical patches for your system
 
 Note it is possible to block the attacks without installing the patch by doing one of the following:
- Uninstall the network component "File and Printer Sharing for Microsoft Networks"
- [Disable nbt.sys and block port 139 and 445](/article/winnt-smb-netbios.html)

##### Exploiters:

 More information about the Server service attackers:
 - [Graweg](http://onecare.live.com/standard/en-us/virusenc/VirusEncInfo.htm?VirusID=3661) [Mocbot](http://www.f-secure.com/v-descs/ircbot_st.shtml) [Wargbot](http://www.symantec.com/security_response/writeup.jsp?docid=2006-081312-3302-99) [Cuebot-M](http://www.sophos.com/security/analyses/w32cuebotm.html) (wgavm.exe - Windows Genuine Advantage Validation Monitor)